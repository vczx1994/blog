(window.webpackJsonp=window.webpackJsonp||[]).push([[165],{668:function(t,s,e){"use strict";e.r(s);var a=e(42),n=Object(a.a)({},(function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"node-中异常-exit-code-与-docker"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#node-中异常-exit-code-与-docker"}},[t._v("#")]),t._v(" Node 中异常，exit code 与 docker")]),t._v(" "),e("p",[t._v("最近观察项目 "),e("code",[t._v("CI")]),t._v(" 跑的情况如何时，会偶尔发现一两个镜像虽然构建成功但是容器跑不起来的情况。究其原因，是因为一个 "),e("code",[t._v("exit code")]),t._v(" 的问题")]),t._v(" "),e("h2",{attrs:{id:"throw-new-error-与-promise-reject-区别"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#throw-new-error-与-promise-reject-区别"}},[t._v("#")]),t._v(" "),e("code",[t._v("throw new Error")]),t._v(" 与 "),e("code",[t._v("Promise.reject")]),t._v(" 区别")]),t._v(" "),e("p",[t._v("以下是两段代码，第一个是抛出一个异常，第二个是 "),e("code",[t._v("Promise.reject")]),t._v("，两段代码都会如下打印出一段异常信息，那么两者有什么区别？")]),t._v(" "),e("div",{staticClass:"language-javascript extra-class"},[e("pre",{pre:!0,attrs:{class:"language-javascript"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("error")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throw")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Error")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'hello, error'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("error")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// /Users/shanyue/Documents/note/demo.js:2")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//   throw new Error('hello, world')")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//   ^")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Error: hello, world")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//     at error (/Users/shanyue/Documents/note/demo.js:2:9)")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//     at Object.<anonymous> (/Users/shanyue/Documents/note/demo.js:5:1)")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//     at Module._compile (internal/modules/cjs/loader.js:701:30)")]),t._v("\n")])])]),e("div",{staticClass:"language-javascript extra-class"},[e("pre",{pre:!0,attrs:{class:"language-javascript"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("error")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Error")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'hello, error'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("error")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// (node:60356) UnhandledPromiseRejectionWarning: Error: hello, world")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//    at error (/Users/shanyue/Documents/note/demo.js:2:9)")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//    at Object.<anonymous> (/Users/shanyue/Documents/note/demo.js:5:1)")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//    at Module._compile (internal/modules/cjs/loader.js:701:30)")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//    at Object.Module._extensions..js (internal/modules/cjs/loader.js:712:10)")]),t._v("\n")])])]),e("p",[t._v("从一个比较底层的角度来说，两者的 "),e("code",[t._v("exit code")]),t._v(" 不一样，那 "),e("code",[t._v("exit code")]),t._v(" 是什么东西？")]),t._v(" "),e("h2",{attrs:{id:"exit-code"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#exit-code"}},[t._v("#")]),t._v(" exit code")]),t._v(" "),e("p",[t._v("那 exit code 到底是什么呢？")]),t._v(" "),e("p",[e("strong",[e("code",[t._v("exit code")]),t._v(" 代表一个进程的返回码，通过系统调用 "),e("code",[t._v("exit_group")]),t._v(" 来触发。在 "),e("code",[t._v("POSIX")]),t._v(" 中，"),e("code",[t._v("0")]),t._v(" 代表正常的返回码，而 "),e("code",[t._v("1-255")]),t._v(" 代表异常返回码，不过一般错误码都是 "),e("code",[t._v("1")]),t._v("。这里有一张附表 "),e("a",{attrs:{href:"http://www.tldp.org/LDP/abs/html/exitcodes.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Appendix E. Exit Codes With Special Meanings"),e("OutboundLink")],1)])]),t._v(" "),e("p",[t._v("所以，在 node 的应用中经常会有 "),e("code",[t._v("process.exit(1)")]),t._v(" 来代表因为不期望的异常而中断。")]),t._v(" "),e("p",[t._v("现在看一个关于 "),e("code",[t._v("cat")]),t._v(" 的异常以及它的 "),e("code",[t._v("exit code")]),t._v(" 与系统调用")]),t._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[t._v("$ "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" a\ncat: a: No such "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("file")]),t._v(" or directory\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# -e 代表只显示 write 与 exit_group 的系统调用")]),t._v("\n$ "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("strace")]),t._v(" -e write,exit_group "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" a\nwrite"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(", "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"cat: "')]),t._v(", 5cat: "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("                    "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),t._v("\nwrite"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(", "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"a"')]),t._v(", 1a"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("                        "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\nwrite"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(", "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('": No such file or directory"')]),t._v(", "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("27")]),t._v(": No such "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("file")]),t._v(" or directory"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("27")]),t._v("\nwrite"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(", "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),e("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v('"')]),t._v(", "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("                       "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\nexit_group"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("                           "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ?\n+++ exited with "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" +++\n")])])]),e("p",[t._v("可以看出，它的 "),e("code",[t._v("exit code")]),t._v(" 是 1，并且把错误信息写到 "),e("code",[t._v("stderr")]),t._v(" (标准错误的 fd 为2) 中了")]),t._v(" "),e("h2",{attrs:{id:"如何查看-exit-code"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#如何查看-exit-code"}},[t._v("#")]),t._v(" 如何查看 exit code")]),t._v(" "),e("p",[t._v("其实从上边的内容可以看出，可以使用 "),e("code",[t._v("strace")]),t._v(" 来判断进程的 "),e("code",[t._v("exit code")]),t._v("。但是这样实在太不方便了，特别是在 shell 编程环境中。")]),t._v(" "),e("p",[e("strong",[t._v("有一种简单的方法，通过 "),e("code",[t._v("echo $?")]),t._v(" 来输出返回码")])]),t._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[t._v("$ "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" a\ncat: a: No such "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("file")]),t._v(" or directory\n\n$ "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$?")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n")])])]),e("p",[e("strong",[t._v("在对上述两个测试用例查看 exit code，我们会发现 "),e("code",[t._v("throw new Error()")]),t._v(" 的 "),e("code",[t._v("exit code")]),t._v(" 为 1，而 "),e("code",[t._v("Promise.reject()")]),t._v(" 的为 0。")])]),t._v(" "),e("h2",{attrs:{id:"dockerfile-在-node-中的注意点"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#dockerfile-在-node-中的注意点"}},[t._v("#")]),t._v(" Dockerfile 在 node 中的注意点")]),t._v(" "),e("p",[t._v("node 中的异常与 "),e("code",[t._v("exit code")]),t._v(" 都说完了，接下来该说与 "),e("code",[t._v("Dockerfile")]),t._v(" 的关联了。")]),t._v(" "),e("p",[t._v("当使用 "),e("code",[t._v("Dockerfile")]),t._v(" 构建镜像时，如果其中 "),e("code",[t._v("RUN")]),t._v(" 的进程返回非0的返回码，则构建就会失败。")]),t._v(" "),e("p",[e("strong",[t._v("而在 "),e("code",[t._v("Node")]),t._v(" 中的错误处理中，我们倾向于所有的异常都交由 "),e("code",[t._v("async/await")]),t._v(" 来处理，而当发生异常时，由于此时 exit code 为 0 并不会导致镜像构建失败。")]),t._v(" 如下所示")]),t._v(" "),e("div",{staticClass:"language-Dockerfile extra-class"},[e("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" node"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("alpine\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("RUN")]),t._v(" node "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("e "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("\"Promise.reject('hello, world')\"")]),t._v("\n")])])]),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[t._v("$ docker build -t demo "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("\nSending build context to Docker daemon  "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("14")]),t._v(".85kB\nStep "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("/2 "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" FROM node:alpine\n ---"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" d97a436daee9\nStep "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("/2 "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" RUN node -e "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("\"Promise.reject('hello, world')\"")]),t._v("\n ---"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" Running "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" 0281c660ab82\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("node:1"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" UnhandledPromiseRejectionWarning: hello, world\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("node:1"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" UnhandledPromiseRejectionWarning: Unhandled promise rejection. This error originated either by throwing inside of an async "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" without a catch block, or by rejecting a promise "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("which")]),t._v(" was not handled with .catch"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(". "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rejection id: "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("node:1"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("DEP0018"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" DeprecationWarning: Unhandled promise rejections are deprecated. In the future, promise rejections that are not handled will terminate the Node.js process with a non-zero "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("exit")]),t._v(" code.\nRemoving intermediate container 0281c660ab82\n ---"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" 2146545654d2\nSuccessfully built 2146545654d2\nSuccessfully tagged demo:latest\n")])])]),e("p",[e("strong",[t._v("而在编译时能发现的问题，绝不要放在运行时。所以，构建镜像需要执行 node 的脚本时，对异常处理需要手动指定 1 的 "),e("code",[t._v("exit code")]),t._v("："),e("code",[t._v("process.exit(1)")]),t._v("。")])]),t._v(" "),e("div",{staticClass:"language-javascript extra-class"},[e("pre",{pre:!0,attrs:{class:"language-javascript"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("runScript")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("catch")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  process"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("exit")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])])])}),[],!1,null,null,null);s.default=n.exports}}]);