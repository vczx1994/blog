(window.webpackJsonp=window.webpackJsonp||[]).push([[19],{347:function(t,e,v){t.exports=v.p+"assets/img/sentry-rate-limit-org.9f0939bf.png"},401:function(t,e,v){t.exports=v.p+"assets/img/sentry-rate-limit-project.cb2895de.png"},532:function(t,e,v){"use strict";v.r(e);var _=v(42),r=Object(_.a)({},(function(){var t=this,e=t.$createElement,_=t._self._c||e;return _("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[_("h1",{attrs:{id:"sentry-异常上报失败与-429-问题"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#sentry-异常上报失败与-429-问题"}},[t._v("#")]),t._v(" Sentry 异常上报失败与 429 问题")]),t._v(" "),_("p",[t._v("这是一个在优化前端异常上报时出现的问题")]),t._v(" "),_("blockquote",[_("p",[t._v("山月人肉盯着异常报了半个小时，但是在 Sentry 中仍然没有收到一条报错，郁闷不已，反复踌躇徘徊。喝一杯水后顿悟，然后发现了那条 http 状态码为 429 的异常上报请求。")])]),t._v(" "),_("h2",{attrs:{id:"捉虫"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#捉虫"}},[t._v("#")]),t._v(" 捉虫")]),t._v(" "),_("p",[t._v("刚开始碰到 Sentry 中未收到报错 (Event) 时，一直在尝试去找 Sentry 服务器端的 "),_("code",[t._v("Inbound Filter")]),t._v(" 设置以及 Sentry 客户端的 "),_("code",[t._v("beforeSend")]),t._v(" 设置，这两个均与 "),_("code",[t._v("Event")]),t._v(" 的过滤有关。以致于耽搁了半个小时。")]),t._v(" "),_("p",[_("strong",[t._v("日志是排查问题时最重要的线索！！！")])]),t._v(" "),_("p",[t._v("后来回过神来，在控制台网络中找到了 http 429 的这条请求，而 429 的描述语为 "),_("code",[t._v("Too Many Requests")]),t._v("。出现了 429，往往代表着 API 被限流了。")]),t._v(" "),_("h2",{attrs:{id:"原因"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#原因"}},[t._v("#")]),t._v(" 原因")]),t._v(" "),_("p",[t._v("在 Sentry 上对于异常上报设置了 "),_("code",[t._v("Rate Limit")]),t._v("，每小时最多只能上报 1000 个Event，导致许多异常被丢弃。")]),t._v(" "),_("p",[_("img",{attrs:{src:v(347),alt:"Rate Limit By Org"}})]),t._v(" "),_("p",[_("img",{attrs:{src:v(401),alt:"Rate Limit By Project"}})]),t._v(" "),_("p",[_("strong",[t._v("图中红色的部分是丢弃的 Event，可以看出丢弃的比捕捉到的更要多！")])]),t._v(" "),_("h2",{attrs:{id:"解决"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#解决"}},[t._v("#")]),t._v(" 解决")]),t._v(" "),_("p",[t._v("基于以往上报及丢弃的 Event 数量，往大调整 "),_("code",[t._v("Rate Limit")])]),t._v(" "),_("p",[_("img",{attrs:{src:v(347),alt:"Rate Limit By Org"}})]),t._v(" "),_("h2",{attrs:{id:"总结"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),_("ol",[_("li",[t._v("还好这次问题暴露在前端的 Sentry 上报，可以很方便地通过 "),_("code",[t._v("devtools -> network")]),t._v(" 来查询日志，如果本次是后端上报异常的话，就会较难调试，可能得用上一天时间")]),t._v(" "),_("li",[_("strong",[t._v("对 Sentry 此类异常上报系统，作为业务层重要的基础设施，还是要多一分熟悉，平时才能更好地定位 Bug")])])]),t._v(" "),_("h2",{attrs:{id:"反思"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#反思"}},[t._v("#")]),t._v(" 反思")]),t._v(" "),_("p",[t._v("关于异常监控系统，很多开发同学往往只注重如何去上报，但这远远不够！因为只注重如何去上报只是异常上报链路中的一个生产侧，不谋全局者不足谋一域。此时开发更应该在更高的角度去思考：")]),t._v(" "),_("ol",[_("li",[t._v("每个异常有没有都上报上去，会不会被限流或其他原因(如磁盘满了)被丢弃掉")]),t._v(" "),_("li",[t._v("每个异常上报上去后，如何去设计 Alert 规则：邮箱还是钉钉？警告要触发吗？")])]),t._v(" "),_("h2",{attrs:{id:"拓展"}},[_("a",{staticClass:"header-anchor",attrs:{href:"#拓展"}},[t._v("#")]),t._v(" 拓展")]),t._v(" "),_("p",[t._v("这里拓展一些关于异常上报的注意点，关于 Sentry 异常上报信息有三大关键字段及两大核心概念")]),t._v(" "),_("p",[t._v("三大关键字段指：")]),t._v(" "),_("ol",[_("li",[_("code",[t._v("Tags")]),t._v("，也可以认为是 "),_("code",[t._v("Index")]),t._v("，作为索引，方便查询。如 userId，errorCode 前端还会涉及到浏览器及一些业务相关要素。")]),t._v(" "),_("li",[_("code",[t._v("Stack")]),t._v("，异常堆栈，方便在异常系统直接定位代码")]),t._v(" "),_("li",[_("code",[t._v("Context")]),t._v("，相关上下文信息，如发请求的 "),_("code",[t._v("url")]),t._v(" 及 "),_("code",[t._v("body")]),t._v("，执行数据库查询的 "),_("code",[t._v("sql")]),t._v(" 等")])]),t._v(" "),_("p",[t._v("两大核心概念：")]),t._v(" "),_("ol",[_("li",[_("code",[t._v("Event")]),t._v("，报一次错就是一个 "),_("code",[t._v("Event")])]),t._v(" "),_("li",[_("code",[t._v("Issue")]),t._v("，如一个 Bug 导致了 N 次 Event，则会聚合为一个 "),_("code",[t._v("Issue")]),t._v("，关于聚合算法，会根据 "),_("code",[t._v("fingerprint")]),t._v(" 来辨别")])]),t._v(" "),_("p",[t._v("如果以上这些做好了，无论采用 "),_("code",[t._v("ElaticSearch")]),t._v(" 还是 "),_("code",[t._v("Sentry")]),t._v(" 做异常上报都是无关紧要的。")]),t._v(" "),_("blockquote",[_("p",[t._v("好吧，其实还是有很大不一样的，比如 Sentry 作为专一的异常上报系统，则会有更好的 Alert，而 ES 做 Alert 就很难了。且 Sentry 对 User Feedback，Event Group，Bug workflow 及与 jira，gitlab 的集成更好。")])]),t._v(" "),_("p",[t._v("关于 "),_("code",[t._v("Node")]),t._v(" 服务端的异常上报可以参考我以前的文章：")]),t._v(" "),_("ol",[_("li",[_("a",{attrs:{href:"https://shanyue.tech/node/error.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Node 异常结构化与上报"),_("OutboundLink")],1)])])])}),[],!1,null,null,null);e.default=r.exports}}]);