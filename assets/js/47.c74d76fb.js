(window.webpackJsonp=window.webpackJsonp||[]).push([[47],{527:function(a,t,s){"use strict";s.r(t);var e=s(42),n=Object(e.a)({},(function(){var a=this,t=a.$createElement,s=a._self._c||t;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("p",[a._v("date: 2020-06-23 19:10")]),a._v(" "),s("hr"),a._v(" "),s("h1",{attrs:{id:"在-k8s-中部署-es-时权限不足导致-pod-crashloopbackoff"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#在-k8s-中部署-es-时权限不足导致-pod-crashloopbackoff"}},[a._v("#")]),a._v(" 在 k8s 中部署 ES 时权限不足导致 pod CrashLoopBackOff")]),a._v(" "),s("p",[a._v("在 k8s 中通过 helm 来部署 ES 时，master 相关 Pod 与 data 相关 Pod 的状态为 "),s("code",[a._v("CrashLoopBackOff")]),a._v("。")]),a._v(" "),s("p",[a._v("部署 "),s("code",[a._v("ES")]),a._v(" 选择了 "),s("code",[a._v("bitnami")]),a._v(" 的 "),s("code",[a._v("Chart")])]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("$ helm "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("install")]),a._v(" es bitnami/elasticsearch --values values.yaml\n")])])]),s("p",[a._v("部署了一个 master 节点一个 data 节点 "),s("strong",[a._v("并通过 "),s("code",[a._v("HostPath")]),a._v(" 作为挂载")])]),a._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("global")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("storageClass")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" local"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("storage\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("master")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("replicas")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("data")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("replicas")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v("\n")])])]),s("p",[a._v("关于 "),s("code",[a._v("HostPath")]),a._v(" 的 PV 配置文件如下，挂载到目录 "),s("code",[a._v("/mnt/k8s-data/es/master")])]),a._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("apiVersion")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" v1\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("kind")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" PersistentVolume\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("metadata")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" local"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("es"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("pv"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("master\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("labels")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("type")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" local\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("spec")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("storageClassName")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" local"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("storage\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("capacity")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("storage")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" 8Gi\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("accessModes")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v(" ReadWriteOnce\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("hostPath")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("path")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"/mnt/k8s-data/es/master"')]),a._v("\n")])])]),s("h2",{attrs:{id:"捉虫"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#捉虫"}},[a._v("#")]),a._v(" 捉虫")]),a._v(" "),s("p",[a._v("通过 "),s("code",[a._v("kubectl describe")]),a._v(" 查看节点并无异常")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("$ kubectl describe pod es-elasticsearch-master-0\n")])])]),s("p",[a._v("继续通过 "),s("code",[a._v("kubectl logs")]),a._v("，查看 POD 日志")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("$ kubectl logs es-elasticsearch-master-0\n 07:41:46.42\n 07:41:46.42 Welcome to the Bitnami elasticsearch container\n 07:41:46.42 Subscribe to project updates by watching https://github.com/bitnami/bitnami-docker-elasticsearch\n 07:41:46.42 Submit issues and feature requests at https://github.com/bitnami/bitnami-docker-elasticsearch/issues\n 07:41:46.43\n 07:41:46.43 INFO  "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("==")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" ** Starting Elasticsearch setup **\n 07:41:46.46 INFO  "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("==")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" Configuring/Initializing Elasticsearch"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("..")]),a._v(".\n 07:41:46.49 INFO  "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("==")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" Setting default configuration\n 07:41:46.51 INFO  "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("==")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" Configuring Elasticsearch cluster settings"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("..")]),a._v(".\nOpenJDK "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("64")]),a._v("-Bit Server VM warning: Option UseConcMarkSweepGC was deprecated "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("in")]),a._v(" version "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("9.0")]),a._v(" and will likely be removed "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("in")]),a._v(" a future release.\n\n 07:41:49.32 INFO  "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("==")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" ** Elasticsearch setup finished"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v(" **\n 07:41:49.34 INFO  "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("==")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" ** Starting Elasticsearch **\nOpenJDK "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("64")]),a._v("-Bit Server VM warning: Option UseConcMarkSweepGC was deprecated "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("in")]),a._v(" version "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("9.0")]),a._v(" and will likely be removed "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("in")]),a._v(" a future release.\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2020")]),a._v("-06-23T03:24:09,855"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("ERROR"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("o.e.b.ElasticsearchUncaughtExceptionHandler"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("es-elasticsearch-master-0"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v(" uncaught exception "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("in")]),a._v(" thread "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("main"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v("\norg.elasticsearch.bootstrap.StartupException: ElasticsearchException"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("failed to "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("bind")]),a._v(" service"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" nested: AccessDeniedException"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("/bitnami/elasticsearch/data/nodes"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n")])])]),s("h2",{attrs:{id:"原因"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#原因"}},[a._v("#")]),a._v(" 原因")]),a._v(" "),s("p",[a._v("通过 HostPath 挂载的目录没有访问权限")]),a._v(" "),s("h2",{attrs:{id:"解决"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#解决"}},[a._v("#")]),a._v(" 解决")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("$ "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("cd")]),a._v(" /mnt/k8s-data/es/master\n\n$ "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("chmod")]),a._v(" -R "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("777")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v(".")]),a._v("\n")])])]),s("h2",{attrs:{id:"总结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[a._v("#")]),a._v(" 总结")]),a._v(" "),s("p",[a._v("当碰到 k8s pod 出现问题时，日志最为关键，找问题关键两步")]),a._v(" "),s("ol",[s("li",[s("code",[a._v("kubectl describe pod")])]),a._v(" "),s("li",[s("code",[a._v("kubectl logs")])])])])}),[],!1,null,null,null);t.default=n.exports}}]);