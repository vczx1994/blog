(window.webpackJsonp=window.webpackJsonp||[]).push([[59],{541:function(t,s,a){"use strict";a.r(s);var n=a(42),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("p",[t._v("date: 2020-06-23 20:00")]),t._v(" "),a("hr"),t._v(" "),a("h1",{attrs:{id:"考试系统的并发优化"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#考试系统的并发优化"}},[t._v("#")]),t._v(" 考试系统的并发优化")]),t._v(" "),a("p",[t._v("当学生进行一场考试时涉及到的需要与数据库交互的流程")]),t._v(" "),a("ul",[a("li",[t._v("抽取试卷")]),t._v(" "),a("li",[t._v("新建答题卡: 创建答题卡，关联本场考试所有的答题记录")]),t._v(" "),a("li",[t._v("提交答案: 提交每一道题的答案，写作题需要实时保存")]),t._v(" "),a("li",[t._v("计算时间: 计算整场考试用了多久时间及每道大类型用了多久时间")]),t._v(" "),a("li",[t._v("完成考试: 标记考试为已完成状态，开始批改判分并生成报告")])]),t._v(" "),a("h2",{attrs:{id:"高并发优化手段"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#高并发优化手段"}},[t._v("#")]),t._v(" 高并发优化手段")]),t._v(" "),a("p",[t._v("高并发优化的目的是降低 QPS，可以分为主动与被动")]),t._v(" "),a("ul",[a("li",[t._v("主动: 缓存、异步、队列，这几种方式需要开发者在应用层根据业务精心设计方案并实施落地、消耗实力，但效果明显！")]),t._v(" "),a("li",[t._v("被动: 通过运维手段加机器、限流熔断来缓解服务器压力")])]),t._v(" "),a("p",[t._v("以下是几种可用在考试系统的方案:")]),t._v(" "),a("h3",{attrs:{id:"读缓存-cache-aside"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#读缓存-cache-aside"}},[t._v("#")]),t._v(" 读缓存: Cache Aside")]),t._v(" "),a("p",[t._v("读取数据时:")]),t._v(" "),a("ol",[a("li",[t._v("应用层读取缓存")]),t._v(" "),a("li",[t._v("缓存未命中")]),t._v(" "),a("li",[t._v("应用层读取数据库、并写入缓存")])]),t._v(" "),a("p",[t._v("数据需要更新时:")]),t._v(" "),a("ol",[a("li",[t._v("更新数据库")]),t._v(" "),a("li",[t._v("删除缓存")])]),t._v(" "),a("h3",{attrs:{id:"写缓存-write-behind"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#写缓存-write-behind"}},[t._v("#")]),t._v(" 写缓存: Write Behind")]),t._v(" "),a("ol",[a("li",[t._v("应用层批量写入缓存")]),t._v(" "),a("li",[t._v("寻找一个合适的时机或者定时任务同步数据库")])]),t._v(" "),a("h3",{attrs:{id:"队列"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#队列"}},[t._v("#")]),t._v(" 队列")]),t._v(" "),a("p",[t._v("削峰、解耦的作用")]),t._v(" "),a("ol",[a("li",[t._v("塞到消息丢列中、随后处理")]),t._v(" "),a("li",[t._v("从消息队列那数据，然后做各种操作")])]),t._v(" "),a("h3",{attrs:{id:"异步"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#异步"}},[t._v("#")]),t._v(" 异步")]),t._v(" "),a("p",[t._v("丢列和写缓存的操作就是异步的，算是被动异步吧")]),t._v(" "),a("ol",[a("li",[t._v("Write Behind 是异步的")]),t._v(" "),a("li",[t._v("消息队列也是异步的")])]),t._v(" "),a("h3",{attrs:{id:"加机器、限流、降级、熔断"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#加机器、限流、降级、熔断"}},[t._v("#")]),t._v(" 加机器、限流、降级、熔断")]),t._v(" "),a("h2",{attrs:{id:"考试操作涉及到的请求与查库频次"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#考试操作涉及到的请求与查库频次"}},[t._v("#")]),t._v(" 考试操作涉及到的请求与查库频次")]),t._v(" "),a("p",[t._v("以下是理想情况下的答题逻辑，实际业务中更为复杂")]),t._v(" "),a("ul",[a("li",[t._v("抽取试卷 (API 1次, SELECT 1次): "),a("code",[t._v("GET /api/papers/:id")]),t._v("，虽然查询涉及的表很多，但仍视作一次查询\n"),a("ul",[a("li",[t._v("抽取该试卷")]),t._v(" "),a("li",[t._v("抽取该试卷的大题 (Section、Group，如高考英语的听力部分为 Section，听力部分的每一道大题是 Group)")]),t._v(" "),a("li",[t._v("抽取每道答题包含的小题及若干材料")])])]),t._v(" "),a("li",[t._v("提交答案 (API n次, SELECT 2n次, UPDATE n次): "),a("code",[t._v("PUT /api/sheets/:id/submit")]),t._v(" 及 body "),a("code",[t._v("{ questionId: 10010, answer: ['A'], timestamp }")]),t._v(" "),a("ul",[a("li",[t._v("查询该答题卡是否为本人所有及本次考试是否结束 SELECT")]),t._v(" "),a("li",[t._v("查询该行答案记录 SELECT")]),t._v(" "),a("li",[t._v("对比时间，插入新的答案 UPDATE")])])]),t._v(" "),a("li",[t._v("计算时间 (API n次, SELECT n次, UPDATE n次): "),a("code",[t._v("PUT /api/sheets/:id/duration")]),t._v(" "),a("ul",[a("li",[t._v("查询该答题卡是否为本人所有及本次考试是否结束 SELECT")]),t._v(" "),a("li",[t._v("更新答题卡的已考试时间 UPDATE")])])]),t._v(" "),a("li",[t._v("完成考试 (API 1次, SELECT 1次, UPDATE 1次): "),a("code",[t._v("PUT /api/sheets/:id/complete")]),t._v(" "),a("ul",[a("li",[t._v("更新该答题卡为已完成状态")]),t._v(" "),a("li",[t._v("扔到消息队列中通知批改")])])])]),t._v(" "),a("p",[t._v("假设一个考试系统同时有 10000 人参加考试，计算此时的频率如下")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("操作")]),t._v(" "),a("th",[t._v("API 频次")]),t._v(" "),a("th",[t._v("SELECT 频次")]),t._v(" "),a("th",[t._v("UPDATE 频次")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("抽取试卷")]),t._v(" "),a("td",[t._v("10000")]),t._v(" "),a("td",[t._v("10000")]),t._v(" "),a("td",[t._v("0")])]),t._v(" "),a("tr",[a("td",[t._v("提交答案")]),t._v(" "),a("td",[t._v("10000n")]),t._v(" "),a("td",[t._v("20000n")]),t._v(" "),a("td",[t._v("10000n")])]),t._v(" "),a("tr",[a("td",[t._v("计算时间")]),t._v(" "),a("td",[t._v("10000n")]),t._v(" "),a("td",[t._v("10000n")]),t._v(" "),a("td",[t._v("10000n")])]),t._v(" "),a("tr",[a("td",[t._v("完成考试")]),t._v(" "),a("td",[t._v("10000")]),t._v(" "),a("td",[t._v("10000")]),t._v(" "),a("td",[t._v("10000")])])])]),t._v(" "),a("p",[a("strong",[t._v("假设学生在写作时会每秒保存一次、并恰好此时进行了考试进度计算时间的保存，则此时关于请求的 "),a("code",[t._v("RPS")]),t._v(" 为 20000，"),a("code",[t._v("QPS")]),t._v(" 为 50000")])]),t._v(" "),a("p",[t._v("显然，此时对于服务器及数据库的压力过大，需要进行优化")]),t._v(" "),a("h2",{attrs:{id:"服务端读缓存优化"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#服务端读缓存优化"}},[t._v("#")]),t._v(" 服务端读缓存优化")]),t._v(" "),a("p",[t._v("高并发的读操作是最容易进行优化的地方，特别是对于试卷这种一次写入后不再更改的数据。")]),t._v(" "),a("h3",{attrs:{id:"抽取试卷"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#抽取试卷"}},[t._v("#")]),t._v(" 抽取试卷")]),t._v(" "),a("ul",[a("li",[t._v("抽取该试卷")]),t._v(" "),a("li",[t._v("抽取该试卷的大题 (Section、Group，如高考英语的听力部分为 Section，听力部分的每一道大题是 Group)")]),t._v(" "),a("li",[t._v("抽取每道答题包含的小题及若干材料")])]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getPaperFromCache")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("id")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("cacheBehind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" models"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Paper"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("cacheBehind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" model")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" key "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token template-string"}},[a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("model"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("name"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("id"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" value "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" redis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("get")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("value"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" value\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" data "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" model"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("findById")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" redis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("set")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" value"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'EX'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'7d'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" data\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h3",{attrs:{id:"提交答案"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#提交答案"}},[t._v("#")]),t._v(" 提交答案")]),t._v(" "),a("ul",[a("li",[t._v("查询该答题卡是否为本人所有及本次考试是否结束 "),a("code",[t._v("SELECT 10000n 次")])]),t._v(" "),a("li",[t._v("查询该行答案记录 "),a("code",[t._v("SELECT 10000n 次")])]),t._v(" "),a("li",[t._v("对比时间，插入新的答案 "),a("code",[t._v("UPDATE 10000n 次")])])]),t._v(" "),a("p",[t._v("在提交答案时，先存储到 "),a("code",[t._v("redis")]),t._v(" 中，此时可以避免考试时大量的并发写库操作")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("submitAnser")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" sheetId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" questionId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" answer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" timestamp "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" sheet "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getSheetFromCache")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sheetId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...省去一系列无关查库的关于是否能插入答案的逻辑操作")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" key "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token template-string"}},[a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("Sheet:")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("sheetId"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v(":Question:")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("questionId"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v(":answer")]),a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" prevAnswer "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" redis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("get")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...省去一系列关于比较时间戳能否插入答案的逻辑操作")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" redis"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("set")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" answer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" timestamp "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'EX'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'7d'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("那如何落盘到数据库中呢，此时可以采用 "),a("code",[t._v("Write Behind Caching")]),t._v(" 策略，")]),t._v(" "),a("ol",[a("li",[t._v("针对已提交答题卡：当提交答题卡时、扔到消息队列，通知同步答案并做批改")]),t._v(" "),a("li",[t._v("针对未提交答题卡：每次提交答案时，把该条答案 ID 存入 "),a("code",[t._v("reids set")]),t._v(" 中，每日凌晨两点同步数据库并删除 "),a("code",[t._v("Set")])])]),t._v(" "),a("p",[t._v("此时经过优化，一万人同时考试，其关于提交答案的查库频次为")]),t._v(" "),a("ul",[a("li",[t._v("查询该答题卡是否为本人所有及本次考试是否结束 "),a("code",[t._v("SELECT 10000 次")])]),t._v(" "),a("li",[t._v("查询该行答案记录 "),a("code",[t._v("SELECT 0 次")])]),t._v(" "),a("li",[t._v("对比时间，插入新的答案 "),a("code",[t._v("UPDATE 0 次")])])]),t._v(" "),a("p",[t._v("假设：")]),t._v(" "),a("ol",[a("li",[t._v("一万人参加一百场不同科目考试，共有一百张试卷")])]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("操作")]),t._v(" "),a("th",[t._v("API 频次")]),t._v(" "),a("th",[t._v("SELECT 频次")]),t._v(" "),a("th",[t._v("UPDATE 频次")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("抽取试卷")]),t._v(" "),a("td",[t._v("10000")]),t._v(" "),a("td",[t._v("100")]),t._v(" "),a("td",[t._v("0")])]),t._v(" "),a("tr",[a("td",[t._v("提交答案")]),t._v(" "),a("td",[t._v("10000n")]),t._v(" "),a("td",[t._v("1")]),t._v(" "),a("td",[t._v("1")])]),t._v(" "),a("tr",[a("td",[t._v("计算时间")]),t._v(" "),a("td",[t._v("10000n")]),t._v(" "),a("td",[t._v("1")]),t._v(" "),a("td",[t._v("1")])]),t._v(" "),a("tr",[a("td",[t._v("完成考试")]),t._v(" "),a("td",[t._v("10000")]),t._v(" "),a("td",[t._v("1")]),t._v(" "),a("td",[t._v("1")])])])]),t._v(" "),a("h2",{attrs:{id:"前端缓存优化"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#前端缓存优化"}},[t._v("#")]),t._v(" 前端缓存优化")]),t._v(" "),a("h3",{attrs:{id:"提交答案-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#提交答案-2"}},[t._v("#")]),t._v(" 提交答案")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 关于应用的全局状态管理 store")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" answers "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    questionId"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    answer"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'A'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    lastModified"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Date")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'2020-07-31T03:04:04.273Z'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    isSync"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("101")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    questionId"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("101")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    answer"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'B'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    lastModified"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Date")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'2020-07-31T03:04:04.273Z'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    isSync"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 更新答案")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("updateAnswer")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" answer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" now "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Date")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" prevAnswer "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" answers"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...省去一系列关于比较时间戳能否插入答案的逻辑操作")]),t._v("\n\n  answers"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    questionId"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    answer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    lastModified"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" now"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    isSync"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 使用节流、一分钟同步一次 store")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("syncAnswer")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" answersToCommit "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Object"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("values")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("answers"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("filter")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("answer")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("answer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("isSync"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" answer "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("of")]),t._v(" answersToCommit"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("submitAnswer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("answer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 更新 answers 的同步状态")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("ul",[a("li",[a("code",[t._v("redux")])]),t._v(" "),a("li",[a("code",[t._v("redux-persist")])])]),t._v(" "),a("h2",{attrs:{id:"优化前后对比"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#优化前后对比"}},[t._v("#")]),t._v(" 优化前后对比")]),t._v(" "),a("p",[a("strong",[t._v("优化前")])]),t._v(" "),a("blockquote",[a("p",[t._v("n 代表提交次数，经验值在 "),a("code",[t._v("1000-3000")])])]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("操作")]),t._v(" "),a("th",[t._v("API 频次")]),t._v(" "),a("th",[t._v("SELECT 频次")]),t._v(" "),a("th",[t._v("UPDATE 频次")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("抽取试卷")]),t._v(" "),a("td",[t._v("10000")]),t._v(" "),a("td",[t._v("10000")]),t._v(" "),a("td",[t._v("0")])]),t._v(" "),a("tr",[a("td",[t._v("提交答案")]),t._v(" "),a("td",[t._v("10000n")]),t._v(" "),a("td",[t._v("20000n")]),t._v(" "),a("td",[t._v("10000n")])]),t._v(" "),a("tr",[a("td",[t._v("计算时间")]),t._v(" "),a("td",[t._v("10000n")]),t._v(" "),a("td",[t._v("10000n")]),t._v(" "),a("td",[t._v("10000n")])]),t._v(" "),a("tr",[a("td",[t._v("完成考试")]),t._v(" "),a("td",[t._v("10000")]),t._v(" "),a("td",[t._v("10000")]),t._v(" "),a("td",[t._v("10000")])])])]),t._v(" "),a("p",[a("strong",[t._v("优化后")]),t._v("，整场考试的数据库操作已经降为了常量级，大大降低了服务器的压力")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("操作")]),t._v(" "),a("th",[t._v("API 频次")]),t._v(" "),a("th",[t._v("SELECT 频次")]),t._v(" "),a("th",[t._v("UPDATE 频次")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("抽取试卷")]),t._v(" "),a("td",[t._v("10000")]),t._v(" "),a("td",[t._v("1")]),t._v(" "),a("td",[t._v("0")])]),t._v(" "),a("tr",[a("td",[t._v("提交答案")]),t._v(" "),a("td",[t._v("10000 * 120")]),t._v(" "),a("td",[t._v("2")]),t._v(" "),a("td",[t._v("0")])]),t._v(" "),a("tr",[a("td",[t._v("计算时间")]),t._v(" "),a("td",[t._v("10000 * 120")]),t._v(" "),a("td",[t._v("1")]),t._v(" "),a("td",[t._v("0")])]),t._v(" "),a("tr",[a("td",[t._v("完成考试")]),t._v(" "),a("td",[t._v("10000")]),t._v(" "),a("td",[t._v("1")]),t._v(" "),a("td",[t._v("0")])])])])])}),[],!1,null,null,null);s.default=e.exports}}]);